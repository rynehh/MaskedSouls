{
	"name": "mapa_procedural",
	"events": [
		{
			"eventType": "block",
			"conditions": [
				{
					"id": "on-start-of-layout",
					"objectClass": "System",
					"sid": 364916416963677
				}
			],
			"actions": [
				{
					"type": "script",
					"language": "typescript",
					"script": [
						"// ==========================================",
						"// 1. DICCIONARIO DE TILES (IDs)",
						"// ==========================================",
						"const T_PARED_FRONTAL = 0;   ",
						"const T_TECHO = 1;           ",
						"const T_SUELO = 2;           ",
						"const T_LAT_IZQ = 3;         ",
						"const T_LAT_DER = 4;         ",
						"const T_ESQ_INF_DER = 5;     ",
						"const T_ESQ_INF_IZQ = 6;     ",
						"const T_ESQ_INTERNA = 7;  ",
						"const T_SINGLE_BODY = 8;     ",
						"const T_SINGLE_BASE = 9;     ",
						"const T_SINGLE_TOPE = 10;    ",
						"const T_ESQ_SUP_DER = 11;    ",
						"const T_ESQ_SUP_IZQ = 12;    ",
						"const T_ESQ_EXTERNA = 13; ",
						"const T_COL_ISLA = 16; ",
						"",
						"// ==========================================",
						"// 2. CONFIGURACIÓN GENERAL",
						"// ==========================================",
						"const ANCHO = 60;   ",
						"const ALTO = 60;",
						"const DENSIDAD = 2500; ",
						"const NIVEL_ZOOM = 4; ",
						"",
						"// --- PROBABILIDADES PISO (Suman para definir rareza) ---",
						"const CHANCE_TRAMPA = 0.05;   ",
						"const CHANCE_BARRIL = 0.02;   ",
						"const CHANCE_CAJAS = 0.03;    ",
						"const CHANCE_BOTELLA = 0.02; ",
						"const CHANCE_VELA = 0.009;",
						"const CHANCE_VARIOS = 0.002 ",
						"const CHANCE_COFRE = 0.2  ",
						"",
						"// --- PROBABILIDADES PARED ---",
						"const CHANCE_ANTORCHA = 0.6; ",
						"const CHANCE_ESCUDO = 0.2;",
						"const CHANCE_VENTANA = 0.5;  ",
						"",
						"generarMapaFinal();",
						"",
						"function generarMapaFinal() {",
						"    const tilemap = runtime.objects.MapaDeTeselas.getFirstInstance();",
						"    const Jugador = runtime.objects.Sprite.getFirstInstance(); ",
						"",
						"    if (!tilemap) return;",
						"",
						"    // 1. LIMPIEZA",
						"    let mapa: number[][] = [];",
						"    for (let x = 0; x < ANCHO; x++) {",
						"        mapa[x] = [];",
						"        for (let y = 0; y < ALTO; y++) {",
						"            mapa[x][y] = 0; ",
						"            tilemap.setTileAt(x, y, -1); ",
						"        }",
						"    }",
						"",
						"    // 2. GENERACIÓN (GUSANO)",
						"    let x = Math.floor(ANCHO / 2);",
						"    let y = Math.floor(ALTO / 2);",
						"    const inicioX = x;",
						"    const inicioY = y;",
						"    mapa[x][y] = 1; ",
						"    let historial = [{x, y}];",
						"",
						"    for (let i = 0; i < DENSIDAD; i++) {",
						"        if (Math.random() < 0.05) { ",
						"            const r = historial[Math.floor(Math.random() * historial.length)];",
						"            x = r.x; y = r.y;",
						"        }",
						"        const dir = Math.floor(Math.random() * 4);",
						"        let nx = x; let ny = y;",
						"        if (dir === 0) nx++; else if (dir === 1) nx--;",
						"        else if (dir === 2) ny++; else if (dir === 3) ny--;",
						"",
						"        if (nx > 1 && nx < ANCHO - 2 && ny > 1 && ny < ALTO - 2) {",
						"            x = nx; y = ny;",
						"            if (mapa[x][y] === 0) {",
						"                mapa[x][y] = 1; ",
						"                historial.push({x, y});",
						"            }",
						"        }",
						"    }",
						"",
						"    // 3. RENDERIZADO DE PAREDES",
						"    for (let cx = 0; cx < ANCHO; cx++) {",
						"        for (let cy = 0; cy < ALTO; cy++) {",
						"            if (mapa[cx][cy] === 1) {",
						"                tilemap.setTileAt(cx, cy, T_SUELO);",
						"                continue;",
						"            }",
						"            const sArr = (cy > 0) && (mapa[cx][cy - 1] === 1);",
						"            const sAbj = (cy < ALTO-1) && (mapa[cx][cy + 1] === 1);",
						"            const sDer = (cx < ANCHO-1) && (mapa[cx + 1][cy] === 1);",
						"            const sIzq = (cx > 0) && (mapa[cx - 1][cy] === 1);",
						"            const sDiagAbjDer = (cx < ANCHO-1 && cy < ALTO-1) && (mapa[cx + 1][cy + 1] === 1);",
						"            const sDiagAbjIzq = (cx > 0 && cy < ALTO-1) && (mapa[cx - 1][cy + 1] === 1);",
						"            const tocaSuelo = sArr || sAbj || sDer || sIzq || sDiagAbjDer || sDiagAbjIzq;",
						"",
						"            if (!tocaSuelo) { tilemap.setTileAt(cx, cy, -1); continue; }",
						"",
						"            if (sIzq && sDer && sArr && sAbj) tilemap.setTileAt(cx, cy, T_COL_ISLA);",
						"            else if (sIzq && sDer) {",
						"                if (sAbj) tilemap.setTileAt(cx, cy, T_SINGLE_BASE);",
						"                else if (sArr) tilemap.setTileAt(cx, cy, T_SINGLE_TOPE);",
						"                else tilemap.setTileAt(cx, cy, T_SINGLE_BODY); ",
						"            }",
						"            else if (cy + 1 < ALTO && tilemap.getTileAt(cx, cy+1) === T_SINGLE_BODY) tilemap.setTileAt(cx, cy, T_SINGLE_TOPE);",
						"            else if (sAbj && sDer) tilemap.setTileAt(cx, cy, T_ESQ_INF_DER);",
						"            else if (sAbj && sIzq) tilemap.setTileAt(cx, cy, T_ESQ_INF_IZQ);",
						"            else if (sDer) {",
						"                if (sArr) tilemap.setTileAt(cx, cy, T_ESQ_SUP_DER);",
						"                else tilemap.setTileAt(cx, cy, T_LAT_IZQ);",
						"            }",
						"            else if (sIzq) {",
						"                if (sArr) tilemap.setTileAt(cx, cy, T_ESQ_SUP_IZQ);",
						"                else tilemap.setTileAt(cx, cy, T_LAT_DER);",
						"            }",
						"            else if (sAbj) tilemap.setTileAt(cx, cy, T_PARED_FRONTAL);",
						"            else if (sDiagAbjDer) tilemap.setTileAt(cx, cy, T_ESQ_INTERNA);",
						"            else if (sDiagAbjIzq) tilemap.setTileAt(cx, cy, T_ESQ_EXTERNA);",
						"            else tilemap.setTileAt(cx, cy, T_TECHO);",
						"        }",
						"    }",
						"",
						"    // 4. POBLAR NIVEL",
						"    poblarNivel(mapa, tilemap, inicioX, inicioY);",
						"",
						"    // 5. POSICIONAR JUGADOR",
						"    if (Jugador) {",
						"        Jugador.x = inicioX * 32 + 16;",
						"        Jugador.y = inicioY * 32 + 16;",
						"        Jugador.zElevation = 10; ",
						"        runtime.layout.scrollTo(Jugador.x, Jugador.y);",
						"        runtime.layout.scale = NIVEL_ZOOM; ",
						"    }",
						"}",
						"",
						"// ==========================================",
						"// FUNCIÓN ESCALABLE PARA OBJETOS Y DECORACIÓN",
						"// ==========================================",
						"function poblarNivel(mapa: number[][], tilemap: any, inicioX: number, inicioY: number) {",
						"    ",
						"    // --- REFERENCIAS ---",
						"    const ObjBarril = runtime.objects.Barril; ",
						"    const ObjTrampa = runtime.objects.Sprite3; ",
						"    const ObjCaja = runtime.objects.Cajas;",
						"    const ObjBotella = runtime.objects.Botellas;",
						"    const ObjVela = runtime.objects.velas;",
						"    const ObjVarios = runtime.objects.varios;",
						"    ",
						"    // AGREGADO: Referencia al Cofre",
						"    const ObjCofre = runtime.objects.CofreLoot;       ",
						"    ",
						"    const ObjAntorcha = runtime.objects.antorcha; ",
						"    const ObjEscudo = runtime.objects.escudo;    ",
						"    const ObjVentana = runtime.objects.ventana;",
						"",
						"    let paredOcupada: boolean[][] = [];",
						"    for (let x = 0; x < ANCHO; x++) {",
						"        paredOcupada[x] = [];",
						"        for (let y = 0; y < ALTO; y++) {",
						"            paredOcupada[x][y] = false;",
						"        }",
						"    }",
						"",
						"    for (let cx = 1; cx < ANCHO - 1; cx++) {",
						"        for (let cy = 1; cy < ALTO - 1; cy++) {",
						"            ",
						"            const rand = Math.random();",
						"            const px = cx * 32 + 16; ",
						"            const py = cy * 32 + 16; ",
						"",
						"            // =================================================",
						"            // CASO A: PISO (Objetos)",
						"            // =================================================",
						"            if (mapa[cx][cy] === 1) {",
						"                if (cx === inicioX && cy === inicioY) continue;",
						"",
						"                const paredIzq = (mapa[cx-1][cy] === 0);",
						"                const paredDer = (mapa[cx+1][cy] === 0);",
						"                const paredArr = (mapa[cx][cy-1] === 0);",
						"                const paredAbj = (mapa[cx][cy+1] === 0);",
						"",
						"                const esPasilloAngosto = (paredIzq && paredDer) || (paredArr && paredAbj);",
						"",
						"                // --- AGREGADO: LÓGICA DE COFRE (Callejón sin salida) ---",
						"                let murosAlrededor = 0;",
						"                if (paredIzq) murosAlrededor++;",
						"                if (paredDer) murosAlrededor++;",
						"                if (paredArr) murosAlrededor++;",
						"                if (paredAbj) murosAlrededor++;",
						"",
						"                // Si hay 3 o más muros, es un callejón ideal para un cofre",
						"                if (murosAlrededor >= 3) {",
						"                    // 50% de probabilidad de cofre si es un callejón",
						"                    if (Math.random() < 0.5) {",
						"                        const cofre = ObjCofre.createInstance(0, px, py);",
						"                        cofre.zElevation = 1;",
						"                        continue; // Si ponemos cofre, no ponemos nada más",
						"                    }",
						"                }",
						"                // -------------------------------------------------------",
						"",
						"                let acumulado = 0;",
						"",
						"                // 1. OBJETOS QUE BLOQUEAN (Solo si NO es pasillo angosto)",
						"                if (!esPasilloAngosto) {",
						"                    ",
						"                    acumulado += CHANCE_TRAMPA;",
						"                    if (rand < acumulado) {",
						"                        const t = ObjTrampa.createInstance(0, px, py);",
						"                        t.zElevation = 0.1;",
						"                        continue; ",
						"                    }",
						"",
						"                    acumulado += CHANCE_BARRIL;",
						"                    if (rand < acumulado) {",
						"                        const b = ObjBarril.createInstance(0, px, py);",
						"                        b.zElevation = 1; ",
						"                        continue;",
						"                    }",
						"",
						"                    acumulado += CHANCE_CAJAS;",
						"                    if (rand < acumulado) {",
						"                        const c = ObjCaja.createInstance(0, px, py);",
						"                        c.zElevation = 1;",
						"                        continue;",
						"                    }",
						"",
						"                    acumulado += CHANCE_VARIOS;",
						"                    if (rand < acumulado){",
						"                        const v = ObjVarios.createInstance(0, px, py);",
						"                        v.zElevation = 1;",
						"                        continue;",
						"                    }",
						"                }",
						"",
						"                acumulado += CHANCE_BOTELLA;",
						"                if (rand < acumulado) {",
						"                    const bot = ObjBotella.createInstance(0, px, py);",
						"                    bot.zElevation = 0.5; ",
						"                    continue;",
						"                }",
						"",
						"                acumulado += CHANCE_VELA;",
						"                if (rand < acumulado) {",
						"                    const vel = ObjVela.createInstance(0, px, py);",
						"                    vel.zElevation = 0.5;",
						"                    continue;",
						"                }",
						"            }",
						"",
						"            // =================================================",
						"            // CASO B: PARED (Decoración)",
						"            // =================================================",
						"            else if (mapa[cx][cy] === 0) {",
						"                if (paredOcupada[cx-1][cy]) continue;",
						"",
						"                const tileID = tilemap.getTileAt(cx, cy);",
						"",
						"                if (tileID === T_PARED_FRONTAL || tileID === T_ESQ_INF_DER || tileID === T_SINGLE_BASE || tileID === T_COL_ISLA || tileID === T_ESQ_INF_IZQ) {",
						"",
						"                    let acumuladoPared = CHANCE_ANTORCHA;",
						"                    if (rand < acumuladoPared) {",
						"                        const antorcha = ObjAntorcha.createInstance(0, px, py);",
						"                        antorcha.zElevation = 0; ",
						"                        paredOcupada[cx][cy] = true; ",
						"                        continue;",
						"                    }",
						"",
						"                    acumuladoPared += CHANCE_ESCUDO;",
						"                    if (rand < acumuladoPared) {",
						"                        const escudo = ObjEscudo.createInstance(0, px, py);",
						"                        escudo.zElevation = 0; ",
						"                        paredOcupada[cx][cy] = true; ",
						"                        continue;",
						"                    }",
						"",
						"                    acumuladoPared += CHANCE_VENTANA;",
						"                    if (rand < acumuladoPared) {",
						"                        const ventana = ObjVentana.createInstance(0, px, py);",
						"                        ventana.zElevation = 0;",
						"                        paredOcupada[cx][cy] = true; ",
						"                        continue;",
						"                    }",
						"                }",
						"            }",
						"        }",
						"    }",
						"}"
					]
				},
				{
					"type": "script",
					"language": "typescript",
					"script": []
				}
			],
			"sid": 717734631564495
		}
	],
	"sid": 644568585369867
}