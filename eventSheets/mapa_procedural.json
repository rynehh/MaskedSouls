{
	"name": "mapa_procedural",
	"events": [
		{
			"eventType": "block",
			"conditions": [
				{
					"id": "on-start-of-layout",
					"objectClass": "System",
					"sid": 364916416963677
				}
			],
			"actions": [
				{
					"type": "script",
					"language": "typescript",
					"script": [
						"// ==========================================",
						"// 1. DICCIONARIO DE TILES (IDs)",
						"// ==========================================",
						"const T_PARED_FRONTAL = 0;   ",
						"const T_TECHO = 1;           ",
						"const T_SUELO = 2;           ",
						"",
						"const T_LAT_IZQ = 3;         ",
						"const T_LAT_DER = 4;         ",
						"const T_ESQ_INF_DER = 5;     ",
						"const T_ESQ_INF_IZQ = 6;     ",
						"",
						"const T_ESQ_INTERNA = 7;  ",
						"const T_SINGLE_BODY = 8;     ",
						"const T_SINGLE_BASE = 9;     ",
						"const T_SINGLE_TOPE = 10;    ",
						"const T_ESQ_SUP_DER = 11;    ",
						"const T_ESQ_SUP_IZQ = 12;    ",
						"const T_ESQ_EXTERNA = 13; ",
						"",
						"const T_COL_ISLA = 16; ",
						"",
						"// ==========================================",
						"// 2. CONFIGURACIÓN GENERAL",
						"// ==========================================",
						"const ANCHO = 60;   ",
						"const ALTO = 60;",
						"const DENSIDAD = 2500; ",
						"",
						"// Configuración de Cámara",
						"const NIVEL_ZOOM = 5; // Ajusta esto: 1 = Lejos, 4 = Muy Cerca",
						"",
						"// Configuración de Objetos (Probabilidades)",
						"const CHANCE_TRAMPA = 0.006; // 2%",
						"const CHANCE_BARRIL = 0.005; // 5% (Total 7% de ocupación, baja saturación)",
						"",
						"generarMapaFinal();",
						"",
						"function generarMapaFinal() {",
						"    const tilemap = runtime.objects.MapaDeTeselas.getFirstInstance();",
						"    // Asegúrate de que este sea el nombre real de tu jugador en la barra de proyectos",
						"    const Jugador = runtime.objects.Player.getFirstInstance(); ",
						"",
						"    if (!tilemap) return;",
						"",
						"    // ---------------------------------------------------------",
						"    // PASO 1: LIMPIEZA Y PREPARACIÓN DE MATRIZ",
						"    // ---------------------------------------------------------",
						"    let mapa: number[][] = [];",
						"    for (let x = 0; x < ANCHO; x++) {",
						"        mapa[x] = [];",
						"        for (let y = 0; y < ALTO; y++) {",
						"            mapa[x][y] = 0; ",
						"            tilemap.setTileAt(x, y, -1); ",
						"        }",
						"    }",
						"",
						"    // ---------------------------------------------------------",
						"    // PASO 2: GENERACIÓN TERRENO (GUSANO)",
						"    // ---------------------------------------------------------",
						"    let x = Math.floor(ANCHO / 2);",
						"    let y = Math.floor(ALTO / 2);",
						"    const inicioX = x;",
						"    const inicioY = y;",
						"    ",
						"    mapa[x][y] = 1; ",
						"    let historial = [{x, y}];",
						"",
						"    for (let i = 0; i < DENSIDAD; i++) {",
						"        // Probabilidad de ramificación",
						"        if (Math.random() < 0.05) { ",
						"            const r = historial[Math.floor(Math.random() * historial.length)];",
						"            x = r.x; y = r.y;",
						"        }",
						"",
						"        const dir = Math.floor(Math.random() * 4);",
						"        let nx = x; let ny = y;",
						"        if (dir === 0) nx++; else if (dir === 1) nx--;",
						"        else if (dir === 2) ny++; else if (dir === 3) ny--;",
						"",
						"        // Clamp para evitar bordes",
						"        if (nx > 1 && nx < ANCHO - 2 && ny > 1 && ny < ALTO - 2) {",
						"            x = nx; y = ny;",
						"            if (mapa[x][y] === 0) {",
						"                mapa[x][y] = 1; // 1 significa PISO",
						"                historial.push({x, y});",
						"            }",
						"        }",
						"    }",
						"",
						"    // ---------------------------------------------------------",
						"    // PASO 3: RENDERIZADO DE PAREDES Y SUELOS (Autotiling)",
						"    // ---------------------------------------------------------",
						"    for (let cx = 0; cx < ANCHO; cx++) {",
						"        for (let cy = 0; cy < ALTO; cy++) {",
						"            ",
						"            // Si es SUELO, pintamos y saltamos a la siguiente iteración",
						"            if (mapa[cx][cy] === 1) {",
						"                tilemap.setTileAt(cx, cy, T_SUELO);",
						"                continue;",
						"            }",
						"            ",
						"            // Análisis de Vecinos (Solo para Muros)",
						"            const sArr = (cy > 0) && (mapa[cx][cy - 1] === 1);",
						"            const sAbj = (cy < ALTO-1) && (mapa[cx][cy + 1] === 1);",
						"            const sDer = (cx < ANCHO-1) && (mapa[cx + 1][cy] === 1);",
						"            const sIzq = (cx > 0) && (mapa[cx - 1][cy] === 1);",
						"            const sDiagAbjDer = (cx < ANCHO-1 && cy < ALTO-1) && (mapa[cx + 1][cy + 1] === 1);",
						"            const sDiagAbjIzq = (cx > 0 && cy < ALTO-1) && (mapa[cx - 1][cy + 1] === 1);",
						"            const tocaSuelo = sArr || sAbj || sDer || sIzq || sDiagAbjDer || sDiagAbjIzq;",
						"",
						"            // Si es vacío profundo (no toca suelo), borrar tile",
						"            if (!tocaSuelo) { ",
						"                tilemap.setTileAt(cx, cy, -1); ",
						"                continue; ",
						"            }",
						"",
						"            // Árbol de decisiones de Muros",
						"            if (sIzq && sDer && sArr && sAbj) tilemap.setTileAt(cx, cy, T_COL_ISLA);",
						"            else if (sIzq && sDer) {",
						"                if (sAbj) tilemap.setTileAt(cx, cy, T_SINGLE_BASE);",
						"                else if (sArr) tilemap.setTileAt(cx, cy, T_SINGLE_TOPE);",
						"                else tilemap.setTileAt(cx, cy, T_SINGLE_BODY); ",
						"            }",
						"            else if (cy + 1 < ALTO && tilemap.getTileAt(cx, cy+1) === T_SINGLE_BODY) {",
						"                 tilemap.setTileAt(cx, cy, T_SINGLE_TOPE);",
						"            }",
						"            else if (sAbj && sDer) tilemap.setTileAt(cx, cy, T_ESQ_INF_DER);",
						"            else if (sAbj && sIzq) tilemap.setTileAt(cx, cy, T_ESQ_INF_IZQ);",
						"            else if (sDer) {",
						"                if (sArr) tilemap.setTileAt(cx, cy, T_ESQ_SUP_DER);",
						"                else tilemap.setTileAt(cx, cy, T_LAT_IZQ);",
						"            }",
						"            else if (sIzq) {",
						"                if (sArr) tilemap.setTileAt(cx, cy, T_ESQ_SUP_IZQ);",
						"                else tilemap.setTileAt(cx, cy, T_LAT_DER);",
						"            }",
						"            else if (sAbj) tilemap.setTileAt(cx, cy, T_PARED_FRONTAL);",
						"            else if (sDiagAbjDer) tilemap.setTileAt(cx, cy, T_ESQ_INTERNA);",
						"            else if (sDiagAbjIzq) tilemap.setTileAt(cx, cy, T_ESQ_EXTERNA);",
						"            else tilemap.setTileAt(cx, cy, T_TECHO);",
						"        }",
						"    }",
						"",
						"    // ---------------------------------------------------------",
						"    // PASO 4: POBLAR EL NIVEL (Objetos)",
						"    // ---------------------------------------------------------",
						"    // Llamamos a la función auxiliar para mantener el código limpio",
						"    poblarNivel(mapa, inicioX, inicioY);",
						"",
						"    // ---------------------------------------------------------",
						"    // PASO 5: CÁMARA Y JUGADOR",
						"    // ---------------------------------------------------------",
						"    if (Jugador) {",
						"        // Convertir coordenadas de Grid a Pixeles (+16 para centrar)",
						"        Jugador.x = inicioX * 32 + 16;",
						"        Jugador.y = inicioY * 32 + 16;",
						"        Jugador.zElevation = 10; // Asegura que el jugador esté sobre todo",
						"        ",
						"        // Mover cámara",
						"        runtime.layout.scrollTo(Jugador.x, Jugador.y);",
						"        ",
						"        // Aplicar ZOOM",
						"        runtime.layout.scale = NIVEL_ZOOM;",
						"    }",
						"}",
						"",
						"// ==========================================",
						"// FUNCIÓN ESCALABLE PARA OBJETOS",
						"// ==========================================",
						"function poblarNivel(mapa: number[][], inicioX: number, inicioY: number) {",
						"    // Referencias a objetos (Usa tus nombres de proyecto)",
						"    const ObjBarril = runtime.objects.Barril; ",
						"    const ObjTrampa = runtime.objects.Sprite2; ",
						"",
						"    for (let cx = 0; cx < ANCHO; cx++) {",
						"        for (let cy = 0; cy < ALTO; cy++) {",
						"            ",
						"            // VALIDACIÓN CRÍTICA: ¿Es esto suelo?",
						"            // Si mapa[cx][cy] NO es 1, es pared o vacío -> Saltamos.",
						"            if (mapa[cx][cy] !== 1) continue;",
						"",
						"            if (cx === inicioX && cy === inicioY) continue;",
						"",
						"            const rand = Math.random();",
						"            const px = cx * 32 + 16; ",
						"            const py = cy * 32 + 16; ",
						"",
						"            if (rand < CHANCE_TRAMPA) {",
						"                const t = ObjTrampa.createInstance(0, px, py);",
						"                t.zElevation = 0.1; ",
						"            }",
						"            ",
						"            else if (rand < (CHANCE_TRAMPA + CHANCE_BARRIL)) {",
						"                const b = ObjBarril.createInstance(0, px, py);",
						"                b.zElevation = 1; ",
						"            }",
						"",
						"            // 3. AQUÍ PUEDES AGREGAR MÁS COSAS EN EL FUTURO",
						"            // else if (rand < (CHANCE_TRAMPA + CHANCE_BARRIL + CHANCE_ENEMIGO)) { ... }",
						"        }",
						"    }",
						"}"
					]
				},
				{
					"type": "script",
					"language": "typescript",
					"script": []
				}
			],
			"sid": 717734631564495
		}
	],
	"sid": 644568585369867
}